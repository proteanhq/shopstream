services:
  # ──────────────────────────────────────────────
  # Infrastructure
  # ──────────────────────────────────────────────
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    ports:
      - "15432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: identity_local
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
  message-db:
    image: ethangarofolo/message-db:1.3.0
    restart: unless-stopped
    ports:
      - "15433:5432"
    environment:
      POSTGRES_PASSWORD: message_store
      MESSAGE_STORE_POSTGRES_PASSWORD: message_store
    volumes:
      - message-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U message_store"]
      interval: 10s
      timeout: 5s
      retries: 5
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "16379:6379"
    command: redis-server --appendonly yes --loglevel warning
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG && redis-cli info server | grep -v loading:1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────────
  # Application: API Server
  # ──────────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: uvicorn app:app --host 0.0.0.0 --port 8000 --reload --app-dir src
    ports:
      - "8000:8000"
    volumes:
      - ./src:/app/src
      - ../protean:/protean
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/identity_local
      - CATALOGUE_DATABASE_URL=postgresql://postgres:postgres@postgres:5432/catalogue_local
      - MESSAGE_DB_URL=postgresql://message_store:message_store@message-db:5432/message_store
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ──────────────────────────────────────────────
  # Application: Engine Workers
  #
  # Each container runs a single Engine process.
  # Scale with: docker compose up --scale engine-identity=3
  # ──────────────────────────────────────────────
  engine-identity:
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: protean server --domain identity.domain
    volumes:
      - ./src:/app/src
      - ../protean:/protean
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/identity_local
      - MESSAGE_DB_URL=postgresql://message_store:message_store@message-db:5432/message_store
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      message-db:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 1

  engine-catalogue:
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: protean server --domain catalogue.domain
    volumes:
      - ./src:/app/src
      - ../protean:/protean
    environment:
      - CATALOGUE_DATABASE_URL=postgresql://postgres:postgres@postgres:5432/catalogue_local
      - MESSAGE_DB_URL=postgresql://message_store:message_store@message-db:5432/message_store
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      message-db:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 1

  engine-ordering:
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: protean server --domain ordering.domain
    volumes:
      - ./src:/app/src
      - ../protean:/protean
    environment:
      - ORDERING_DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ordering_local
      - MESSAGE_DB_URL=postgresql://message_store:message_store@message-db:5432/message_store
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      message-db:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 1

volumes:
  postgres-data:
    driver: local
  message-db-data:
    driver: local
  redis-data:
    driver: local
